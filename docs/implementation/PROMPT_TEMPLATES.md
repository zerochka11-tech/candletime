# 📝 План реализации промпт-шаблонов для генерации SEO-статей

## 🎯 Цель

Добавить возможность выбора между двумя режимами генерации статей:
1. **Простой режим** (текущий) - генерация по теме, типу свечи и языку
2. **Режим с шаблоном** - использование кастомного промпт-шаблона для более гибкой генерации

## 📊 Архитектура решения

### База данных
- Таблица `prompt_templates` для хранения шаблонов
- Поддержка переменных в шаблонах (например: `{topic}`, `{candleType}`, `{language}`)
- Системные шаблоны (нельзя удалить) и пользовательские

### UI Компоненты
1. **GenerateArticleDialog** - обновленный с выбором режима
2. **PromptTemplateManager** - новый компонент для управления шаблонами
3. **PromptTemplateEditor** - редактор шаблонов
4. **PromptTemplateSelector** - выбор шаблона

### API Endpoints
1. `GET /api/admin/prompt-templates` - список шаблонов
2. `POST /api/admin/prompt-templates` - создание шаблона
3. `GET /api/admin/prompt-templates/[id]` - получение шаблона
4. `PATCH /api/admin/prompt-templates/[id]` - обновление шаблона
5. `DELETE /api/admin/prompt-templates/[id]` - удаление шаблона
6. `POST /api/admin/articles/generate` - обновлен для поддержки шаблонов

## 📋 Структура промпт-шаблона

### Пример шаблона

```json
{
  "name": "Стандартный шаблон",
  "description": "Базовый шаблон для генерации SEO-статей",
  "prompt": "Ты - эксперт по написанию SEO-статей...\n\nТема: {topic}\nЯзык: {language}\n...",
  "variables": ["topic", "candleType", "language"],
  "is_default": true,
  "is_system": true
}
```

### Поддерживаемые переменные

- `{topic}` - тема статьи (обязательная)
- `{candleType}` - тип свечи (опциональная)
- `{language}` - язык статьи (ru/en)
- `{categoryName}` - название категории (опциональная)
- Другие кастомные переменные по желанию пользователя

## 🚀 Этапы реализации

### Этап 1: База данных и SQL миграция ✅
- [x] Создать SQL скрипт для таблицы `prompt_templates`
- [ ] Выполнить миграцию в Supabase
- [ ] Протестировать RLS политики

### Этап 2: API Endpoints
- [ ] Создать `/api/admin/prompt-templates/route.ts`
- [ ] Создать `/api/admin/prompt-templates/[id]/route.ts`
- [ ] Обновить `/api/admin/articles/generate/route.ts` для поддержки шаблонов
- [ ] Добавить валидацию шаблонов

### Этап 3: Библиотека для работы с шаблонами
- [ ] Обновить `lib/gemini.ts`:
  - Функция `replaceTemplateVariables(template, variables)`
  - Обновить `generateArticle` для поддержки кастомных промптов
- [ ] Создать `lib/promptTemplates.ts`:
  - Типы для шаблонов
  - Функции валидации переменных
  - Функции извлечения переменных из промпта

### Этап 4: UI Компоненты

#### 4.1. Компонент управления шаблонами
- [ ] `components/admin/PromptTemplateManager.tsx`:
  - Список всех шаблонов
  - Поиск и фильтрация
  - Кнопки: Создать, Редактировать, Удалить, Использовать

#### 4.2. Редактор шаблонов
- [ ] `components/admin/PromptTemplateEditor.tsx`:
  - Поля: название, описание, промпт
  - Автоматическое определение переменных из промпта
  - Предпросмотр шаблона с примерами
  - Валидация промпта

#### 4.3. Селектор шаблонов
- [ ] `components/admin/PromptTemplateSelector.tsx`:
  - Выпадающий список с шаблонами
  - Поиск шаблонов
  - Предпросмотр выбранного шаблона

#### 4.4. Обновление диалога генерации
- [ ] Обновить `components/admin/GenerateArticleDialog.tsx`:
  - Добавить переключатель режимов (Простой / Шаблон)
  - В простом режиме - текущий UI
  - В режиме шаблона:
    - Выбор шаблона
    - Заполнение переменных шаблона
    - Предпросмотр итогового промпта

### Этап 5: Интеграция и тестирование
- [ ] Интегрировать все компоненты
- [ ] Протестировать создание/редактирование шаблонов
- [ ] Протестировать генерацию статей с шаблонами
- [ ] Проверить валидацию и обработку ошибок

## 🎨 UI/UX Дизайн

### Диалог генерации (обновленный)

```
┌─────────────────────────────────────────────┐
│  🤖 Сгенерировать SEO-статью          [X]  │
├─────────────────────────────────────────────┤
│                                             │
│  Режим генерации:                           │
│  ○ Простой                                  │
│  ● Шаблон                                   │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │ Шаблон: [Стандартный шаблон ▼]       │ │
│  │                                   [✏️] │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  Переменные шаблона:                        │
│  ┌───────────────────────────────────────┐ │
│  │ Тема статьи *                         │ │
│  │ [Практика осознанности...]            │ │
│  └───────────────────────────────────────┘ │
│  ┌───────────────────────────────────────┐ │
│  │ Тип свечи (опционально)               │ │
│  │ [🕊️ Спокойствие ▼]                   │ │
│  └───────────────────────────────────────┘ │
│  ┌───────────────────────────────────────┐ │
│  │ Язык статьи                           │ │
│  │ ○ Русский  ● English                  │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │ 📄 Предпросмотр промпта               │ │
│  │ ...                                   │ │
│  │ Тема: Практика осознанности...        │ │
│  │ ...                                   │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  [Отмена]  [Сгенерировать статью]          │
└─────────────────────────────────────────────┘
```

### Управление шаблонами

```
┌─────────────────────────────────────────────┐
│  📝 Управление промпт-шаблонами      [X]   │
├─────────────────────────────────────────────┤
│                                             │
│  [+ Создать шаблон]                         │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │ 🔍 Поиск шаблонов...                  │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │ Стандартный шаблон        [⚙️] [🗑️]  │ │
│  │ Базовый шаблон для генерации...       │ │
│  │ Системный • По умолчанию              │ │
│  └───────────────────────────────────────┘ │
│  ┌───────────────────────────────────────┐ │
│  │ Мой кастомный шаблон     [✏️] [🗑️]   │ │
│  │ Описание моего шаблона...             │ │
│  │ Пользовательский                      │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  [Закрыть]                                  │
└─────────────────────────────────────────────┘
```

## 🔧 Технические детали

### Обработка переменных в шаблонах

```typescript
function replaceTemplateVariables(
  template: string,
  variables: Record<string, string>
): string {
  let result = template;
  
  for (const [key, value] of Object.entries(variables)) {
    const regex = new RegExp(`\\{${key}\\}`, 'g');
    result = result.replace(regex, value || '');
  }
  
  // Удаляем незаполненные переменные (опционально)
  result = result.replace(/\{[^}]+\}/g, '');
  
  return result;
}
```

### Извлечение переменных из промпта

```typescript
function extractVariablesFromPrompt(prompt: string): string[] {
  const regex = /\{([^}]+)\}/g;
  const variables: string[] = [];
  let match;
  
  while ((match = regex.exec(prompt)) !== null) {
    if (!variables.includes(match[1])) {
      variables.push(match[1]);
    }
  }
  
  return variables;
}
```

### Валидация шаблона

```typescript
function validatePromptTemplate(template: {
  name: string;
  prompt: string;
  variables?: string[];
}): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  if (!template.name || template.name.trim().length < 3) {
    errors.push('Название шаблона должно содержать минимум 3 символа');
  }
  
  if (!template.prompt || template.prompt.trim().length < 50) {
    errors.push('Промпт должен содержать минимум 50 символов');
  }
  
  // Проверка обязательной переменной {topic}
  if (!template.prompt.includes('{topic}')) {
    errors.push('Промпт должен содержать переменную {topic}');
  }
  
  // Проверка валидности переменных
  const variables = extractVariablesFromPrompt(template.prompt);
  const declaredVariables = template.variables || [];
  
  const undeclared = variables.filter(v => !declaredVariables.includes(v));
  if (undeclared.length > 0) {
    errors.push(`Необъявленные переменные: ${undeclared.join(', ')}`);
  }
  
  return {
    valid: errors.length === 0,
    errors
  };
}
```

## 📝 Примеры использования

### Пример 1: Простой шаблон с базовыми переменными

```markdown
Напиши статью на тему "{topic}" на языке {language}.

{ctaSection}
```

### Пример 2: Расширенный шаблон

```markdown
Ты - эксперт по написанию SEO-статей о символических свечах.

Тема статьи: {topic}
Язык: {language}
Тип свечи: {candleType}

Требования:
- Длина: {articleLength} слов
- Стиль: {writingStyle}
- Тон: {tone}

Структура:
1. Введение
2. Основной контент
3. Практические советы
4. Заключение

{ctaSection}
```

## 🚦 Приоритизация

### Must Have:
1. ✅ Структура БД
2. Базовые API endpoints
3. Обновленный диалог с выбором режима
4. Простой селектор шаблонов
5. Генерация с шаблонами

### Should Have:
6. Редактор шаблонов
7. Управление шаблонами (список, удаление)
8. Предпросмотр промпта
9. Валидация переменных

### Nice to Have:
10. Экспорт/импорт шаблонов
11. История использования шаблонов
12. Шаблоны-шаблоны (предустановленные варианты)
13. Коллаборация над шаблонами

## 📊 Метрики успеха

- ✅ Пользователи могут создавать и сохранять промпт-шаблоны
- ✅ Генерация статей работает с кастомными шаблонами
- ✅ UI интуитивно понятен для переключения режимов
- ✅ Валидация предотвращает ошибки в шаблонах

---

**Дата создания:** 2025-01-27
**Версия:** 1.0
**Статус:** Готов к реализации

