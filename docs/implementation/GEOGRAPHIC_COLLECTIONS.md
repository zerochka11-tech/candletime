# üåç –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ –º–µ—Å—Ç

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ü—Ä–æ–µ–∫—Ç:** CandleTime - –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–≤–µ—á–µ–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏](#–æ–±–∑–æ—Ä-–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏)
2. [–ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏](#–ø—Ä–∏–Ω—Ü–∏–ø—ã-–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
5. [–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö](#–∏–∑–º–µ–Ω–µ–Ω–∏—è-–≤-–±–∞–∑–µ-–¥–∞–Ω–Ω—ã—Ö)
6. [–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
7. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-–∏-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–æ–¥–∞)
8. [–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è](#–ø–æ—à–∞–≥–æ–≤–∞—è-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è-–≤–Ω–µ–¥—Ä–µ–Ω–∏—è)
9. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## üéØ –û–±–∑–æ—Ä –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### –¶–µ–ª—å
–ü–æ–∑–≤–æ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å —Å–≤–µ—á–∏ –∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –º–µ—Å—Ç–∞–º, —Å–æ–∑–¥–∞–≤–∞—è:
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –º–∏—Ä–∞
- –ö–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–≤–µ—á–µ–π –ø–æ –≥–æ—Ä–æ–¥–∞–º/—Å—Ç—Ä–∞–Ω–∞–º/—Å–æ–±—ã—Ç–∏—è–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–µ—Å—Ç–∞–º (–∞–Ω–æ–Ω–∏–º–Ω—É—é)
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–≤—è–∑—å —Å –º–µ—Å—Ç–∞–º–∏

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- **–ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** - —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç, –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏ –º–µ—Å—Ç–æ
- **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å** - –¥–µ—Ç–∞–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é
- **–ì–∏–±–∫–æ—Å—Ç—å** - —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ (—Å—Ç—Ä–∞–Ω–∞, –≥–æ—Ä–æ–¥, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –°–≤–µ—á–∞ –ø–∞–º—è—Ç–∏ –æ –≥–æ—Ä–æ–¥–µ, –≥–¥–µ –∂–∏–ª –±–ª–∏–∑–∫–∏–π —á–µ–ª–æ–≤–µ–∫
- –°–≤–µ—á–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã/—Ä–µ–≥–∏–æ–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏–π
- –°–≤–µ—á–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç—É, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
- –ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–≤–µ—á–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–≤–µ—á–∏ –¥–ª—è –£–∫—Ä–∞–∏–Ω—ã")

---

## üîê –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

### –£—Ä–æ–≤–Ω–∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–∫–∞—Ü–∏–∏

1. **–¢–æ—á–Ω—ã–π (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)** - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (lat/lng), –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é
2. **–ì–æ—Ä–æ–¥** - —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ
3. **–°—Ç—Ä–∞–Ω–∞** - —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã, –∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ç–æ—á–∫–∞
4. **–†–µ–≥–∏–æ–Ω** - –∫—Ä—É–ø–Ω—ã–π —Ä–µ–≥–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–í–æ—Å—Ç–æ—á–Ω–∞—è –ï–≤—Ä–æ–ø–∞")
5. **–ë–µ–∑ –º–µ—Å—Ç–∞** - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –Ω–∏–∫–∞–∫–∏—Ö –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∞–≤–∏–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ

- **–ê–Ω–æ–Ω–∏–º–Ω—ã–µ —Ç–æ—á–∫–∏** - —Ç–æ–ª—å–∫–æ –æ–±–æ–±—â–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ ~10-50–∫–º)
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è** - –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–≤–µ—á–µ–π –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ —Å —á–∏—Å–ª–æ–º
- **–ë–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞–ª —Å–≤–µ—á—É
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∫—Ä—ã—Ç—å —Å–≤–æ—é —Å–≤–µ—á—É —Å –∫–∞—Ä—Ç—ã

### –°–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–∏—Ç—å –≥–µ–æ–¥–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
- **Leaflet.js** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã (–ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ Google Maps)
- **OpenStreetMap** - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã (–∏–ª–∏ Mapbox –¥–ª—è –ª—É—á—à–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞)
- **PostgreSQL/PostGIS** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –¥–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Supabase
- **Geocoding API** - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (Nominatim - –±–µ—Å–ø–ª–∞—Ç–Ω–æ)

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
- **Google Maps API** - –ø–ª–∞—Ç–Ω—ã–π, –Ω–æ –±–æ–ª–µ–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
- **Mapbox** - –∫—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω, –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ
- **Azure Maps** - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
npm install leaflet react-leaflet
npm install --save-dev @types/leaflet
```

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Nominatim (–≥–µ–æ–∫–æ–¥–∏–Ω–≥):
```bash
npm install node-geocoder
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

```
components/
  geographic/
    LocationSelector.tsx        # –í—ã–±–æ—Ä –º–µ—Å—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤–µ—á–∏
    LocationDisplay.tsx         # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–≤–µ—á–∏
    CandlesMap.tsx             # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–æ —Å–≤–µ—á–∞–º–∏
    LocationCollection.tsx     # –ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–≤–µ—á–µ–π –ø–æ –º–µ—Å—Ç—É
    LocationStats.tsx          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—Ç—É
  maps/
    MapMarker.tsx              # –ú–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
    MapCluster.tsx             # –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
    HeatmapLayer.tsx           # –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:

```
User selects location ‚Üí Geocoding ‚Üí Store in DB ‚Üí
  ‚îî‚îÄ Display on candle page
  ‚îî‚îÄ Aggregate for map (anonymize)
  ‚îî‚îÄ Show in collections
  ‚îî‚îÄ Include in statistics
```

---

## üíæ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã candles

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
ALTER TABLE candles
ADD COLUMN IF NOT EXISTS location_type TEXT CHECK (location_type IN ('precise', 'city', 'country', 'region', 'none')) DEFAULT 'none',
ADD COLUMN IF NOT EXISTS location_country TEXT,
ADD COLUMN IF NOT EXISTS location_city TEXT,
ADD COLUMN IF NOT EXISTS location_region TEXT,
ADD COLUMN IF NOT EXISTS location_latitude DECIMAL(10, 8),
ADD COLUMN IF NOT EXISTS location_longitude DECIMAL(11, 8),
ADD COLUMN IF NOT EXISTS location_anonymized_lat DECIMAL(10, 8), -- –û–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞—Ä—Ç—ã
ADD COLUMN IF NOT EXISTS location_anonymized_lng DECIMAL(11, 8),
ADD COLUMN IF NOT EXISTS location_show_on_map BOOLEAN DEFAULT true, -- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ
ADD COLUMN IF NOT EXISTS location_address TEXT; -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX IF NOT EXISTS idx_candles_location_country ON candles(location_country) WHERE location_type != 'none';
CREATE INDEX IF NOT EXISTS idx_candles_location_city ON candles(location_city) WHERE location_type != 'none';
CREATE INDEX IF NOT EXISTS idx_candles_location_anonymized ON candles(location_anonymized_lat, location_anonymized_lng) WHERE location_show_on_map = true;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN candles.location_type IS '–¢–∏–ø –ª–æ–∫–∞—Ü–∏–∏: precise (—Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –ø—Ä–∏–≤–∞—Ç–Ω–æ), city, country, region, none';
COMMENT ON COLUMN candles.location_anonymized_lat IS '–û–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ (–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)';
COMMENT ON COLUMN candles.location_show_on_map IS '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —Å–≤–µ—á—É –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ';
```

### 2. –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π –º–µ—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```sql
-- –ö–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–≤–µ—á–µ–π –ø–æ –º–µ—Å—Ç–∞–º/—Å–æ–±—ã—Ç–∏—è–º
CREATE TABLE IF NOT EXISTS location_collections (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  location_country TEXT,
  location_city TEXT,
  location_type TEXT NOT NULL,
  is_public BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  image_url TEXT -- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
);

-- –°–≤—è–∑—å —Å–≤–µ—á–µ–π —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ (many-to-many)
CREATE TABLE IF NOT EXISTS candle_location_collections (
  candle_id UUID REFERENCES candles(id) ON DELETE CASCADE,
  collection_id UUID REFERENCES location_collections(id) ON DELETE CASCADE,
  PRIMARY KEY (candle_id, collection_id)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_location_collections_country ON location_collections(location_country);
CREATE INDEX IF NOT EXISTS idx_location_collections_public ON location_collections(is_public) WHERE is_public = true;
```

### 3. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)
CREATE OR REPLACE FUNCTION anonymize_coordinates(
  lat DECIMAL,
  lng DECIMAL,
  precision_level INTEGER DEFAULT 2 -- –£—Ä–æ–≤–µ–Ω—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è (2 = ~1–∫–º, 1 = ~10–∫–º)
) RETURNS TABLE(anonymized_lat DECIMAL, anonymized_lng DECIMAL) AS $$
BEGIN
  -- –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ precision_level –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
  -- 1 –∑–Ω–∞–∫ ‚âà 11–∫–º, 2 –∑–Ω–∞–∫–∞ ‚âà 1.1–∫–º
  RETURN QUERY
  SELECT
    ROUND(lat::numeric, precision_level)::DECIMAL,
    ROUND(lng::numeric, precision_level)::DECIMAL;
END;
$$ LANGUAGE plpgsql;
```

### 4. RLS –ø–æ–ª–∏—Ç–∏–∫–∏

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
CREATE POLICY "Users can see own precise location"
  ON candles FOR SELECT
  USING (
    auth.uid() = user_id OR
    location_type != 'precise' OR
    location_show_on_map = false
  );

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–≤–æ–∏ –≥–µ–æ–¥–∞–Ω–Ω—ã–µ
CREATE POLICY "Users can update own location"
  ON candles FOR UPDATE
  USING (auth.uid() = user_id);
```

---

## üíª –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)

```typescript
// lib/geocoding.ts
import NodeGeocoder from 'node-geocoder';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Nominatim (OpenStreetMap, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
const geocoder = NodeGeocoder({
  provider: 'openstreetmap',
  httpAdapter: 'https',
  formatter: null,
});

export interface LocationData {
  country?: string;
  city?: string;
  region?: string;
  latitude?: number;
  longitude?: number;
  address?: string;
}

export interface GeocodeResult {
  location: LocationData;
  anonymized: {
    latitude: number;
    longitude: number;
  };
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
 */
export async function geocodeLocation(
  query: string,
  precisionLevel: number = 2
): Promise<GeocodeResult | null> {
  try {
    const results = await geocoder.geocode(query);

    if (!results || results.length === 0) {
      return null;
    }

    const result = results[0];
    const lat = result.latitude;
    const lng = result.longitude;

    if (!lat || !lng) {
      return null;
    }

    // –ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∫–∞—Ä—Ç—ã
    const anonymized = anonymizeCoordinates(lat, lng, precisionLevel);

    return {
      location: {
        country: result.country,
        city: result.city || result.administrativeLevels?.level1short,
        region: result.administrativeLevels?.level1long,
        latitude: lat,
        longitude: lng,
        address: result.formattedAddress,
      },
      anonymized,
    };
  } catch (error) {
    console.error('Geocoding error:', error);
    return null;
  }
}

/**
 * –û–∫—Ä—É–≥–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏
 */
function anonymizeCoordinates(
  lat: number,
  lng: number,
  precisionLevel: number = 2
): { latitude: number; longitude: number } {
  const multiplier = Math.pow(10, precisionLevel);
  return {
    latitude: Math.round(lat * multiplier) / multiplier,
    longitude: Math.round(lng * multiplier) / multiplier,
  };
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ª–æ–∫–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
 */
export function determineLocationType(
  location: LocationData
): 'precise' | 'city' | 'country' | 'region' | 'none' {
  if (location.latitude && location.longitude && location.city) {
    return 'precise';
  }
  if (location.city) {
    return 'city';
  }
  if (location.country) {
    return 'country';
  }
  if (location.region) {
    return 'region';
  }
  return 'none';
}
```

### 2. API Route –¥–ª—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

```typescript
// app/api/geocode/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { geocodeLocation } from '@/lib/geocoding';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const query = searchParams.get('q');

  if (!query) {
    return NextResponse.json(
      { error: 'Query parameter "q" is required' },
      { status: 400 }
    );
  }

  // Rate limiting (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)
  const result = await geocodeLocation(query);

  if (!result) {
    return NextResponse.json(
      { error: 'Location not found' },
      { status: 404 }
    );
  }

  return NextResponse.json(result);
}
```

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏

```typescript
// components/geographic/LocationSelector.tsx
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { LocationData } from '@/lib/geocoding';

interface LocationSelectorProps {
  onLocationSelect: (location: LocationData | null) => void;
  initialLocation?: LocationData;
  required?: boolean;
}

export function LocationSelector({
  onLocationSelect,
  initialLocation,
  required = false,
}: LocationSelectorProps) {
  const [query, setQuery] = useState('');
  const [isSearching, setIsSearching] = useState(false);
  const [selectedLocation, setSelectedLocation] = useState<LocationData | null>(
    initialLocation || null
  );
  const [showOnMap, setShowOnMap] = useState(true);
  const [precisionLevel, setPrecisionLevel] = useState<1 | 2>(2);

  useEffect(() => {
    onLocationSelect(selectedLocation);
  }, [selectedLocation, onLocationSelect]);

  const handleSearch = async () => {
    if (!query.trim()) return;

    setIsSearching(true);
    try {
      const response = await fetch(`/api/geocode?q=${encodeURIComponent(query)}`);
      if (response.ok) {
        const result = await response.json();
        setSelectedLocation(result.location);
      }
    } catch (error) {
      console.error('Location search error:', error);
    } finally {
      setIsSearching(false);
    }
  };

  const handleRemove = () => {
    setSelectedLocation(null);
    setQuery('');
  };

  return (
    <div className="space-y-4">
      <label className="block text-sm font-medium text-slate-700">
        –ú–µ—Å—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        {required && <span className="text-rose-500 ml-1">*</span>}
      </label>

      {/* –ü–æ–∏—Å–∫ –º–µ—Å—Ç–∞ */}
      {!selectedLocation && (
        <div className="flex gap-2">
          <input
            type="text"
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ –∞–¥—Ä–µ—Å..."
            className="flex-1 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
          />
          <button
            onClick={handleSearch}
            disabled={isSearching || !query.trim()}
            className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isSearching ? '–ü–æ–∏—Å–∫...' : '–ù–∞–π—Ç–∏'}
          </button>
        </div>
      )}

      {/* –í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ */}
      <AnimatePresence>
        {selectedLocation && (
          <motion.div
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
            className="p-4 bg-slate-50 rounded-lg border border-slate-200"
          >
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <p className="font-medium text-slate-900">
                  {selectedLocation.address || 
                   `${selectedLocation.city || ''}, ${selectedLocation.country || ''}`.trim() ||
                   '–í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ'}
                </p>
                {selectedLocation.city && (
                  <p className="text-sm text-slate-600 mt-1">
                    {selectedLocation.city}
                    {selectedLocation.country && `, ${selectedLocation.country}`}
                  </p>
                )}
              </div>
              <button
                onClick={handleRemove}
                className="ml-2 text-slate-400 hover:text-slate-600"
                aria-label="–£–¥–∞–ª–∏—Ç—å –º–µ—Å—Ç–æ"
              >
                ‚úï
              </button>
            </div>

            {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ */}
            <div className="mt-4 space-y-3 pt-3 border-t border-slate-200">
              <label className="flex items-center gap-2 text-sm text-slate-700">
                <input
                  type="checkbox"
                  checked={showOnMap}
                  onChange={(e) => setShowOnMap(e.target.checked)}
                  className="rounded border-slate-300 text-amber-500 focus:ring-amber-500"
                />
                <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∫–∞—Ä—Ç–µ</span>
              </label>

              <div className="text-sm text-slate-600">
                <label className="block mb-2">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                <div className="flex gap-3">
                  <label className="flex items-center gap-2">
                    <input
                      type="radio"
                      name="precision"
                      value="2"
                      checked={precisionLevel === 2}
                      onChange={() => setPrecisionLevel(2)}
                      className="border-slate-300 text-amber-500 focus:ring-amber-500"
                    />
                    <span>–ì–æ—Ä–æ–¥ (~1–∫–º)</span>
                  </label>
                  <label className="flex items-center gap-2">
                    <input
                      type="radio"
                      name="precision"
                      value="1"
                      checked={precisionLevel === 1}
                      onChange={() => setPrecisionLevel(1)}
                      className="border-slate-300 text-amber-500 focus:ring-amber-500"
                    />
                    <span>–†–µ–≥–∏–æ–Ω (~10–∫–º)</span>
                  </label>
                </div>
                <p className="text-xs text-slate-500 mt-1">
                  –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ª—É—á—à–µ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
                </p>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ */}
      <p className="text-xs text-slate-500">
        üí° –ú–µ—Å—Ç–æ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ —Ç–æ–ª—å–∫–æ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é. 
        –¢–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞–º.
      </p>
    </div>
  );
}
```

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã —Å–æ —Å–≤–µ—á–∞–º–∏

```typescript
// components/geographic/CandlesMap.tsx
'use client';

import { useEffect, useRef, useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { supabase } from '@/lib/supabaseClient';

// –§–∏–∫—Å –¥–ª—è –∏–∫–æ–Ω–æ–∫ Leaflet –≤ Next.js
delete (L.Icon.Default.prototype as any)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

interface CandleLocation {
  id: string;
  title: string;
  candle_type: string;
  latitude: number;
  longitude: number;
  count?: number; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)
}

interface CandlesMapProps {
  height?: string;
  showControls?: boolean;
}

export function CandlesMap({ height = '400px', showControls = true }: CandlesMapProps) {
  const [candles, setCandles] = useState<CandleLocation[]>([]);
  const [loading, setLoading] = useState(true);
  const [bounds, setBounds] = useState<L.LatLngBounds | null>(null);

  useEffect(() => {
    loadCandles();
  }, []);

  const loadCandles = async () => {
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–≤–µ—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
      const { data, error } = await supabase
        .from('candles')
        .select('id, title, candle_type, location_anonymized_lat, location_anonymized_lng')
        .eq('location_show_on_map', true)
        .not('location_anonymized_lat', 'is', null)
        .not('location_anonymized_lng', 'is', null)
        .eq('status', 'active')
        .limit(1000); // –õ–∏–º–∏—Ç –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

      if (error) throw error;

      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å–≤–µ—á–∏ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫)
      const aggregated = aggregateCandles(data || []);

      setCandles(aggregated);
    } catch (error) {
      console.error('Error loading candles for map:', error);
    } finally {
      setLoading(false);
    }
  };

  // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫
  const aggregateCandles = (
    candles: Array<{
      id: string;
      title: string;
      candle_type: string;
      location_anonymized_lat: number;
      location_anonymized_lng: number;
    }>
  ): CandleLocation[] => {
    const clusters = new Map<string, CandleLocation[]>();
    const clusterRadius = 0.01; // ~1–∫–º

    candles.forEach((candle) => {
      if (!candle.location_anonymized_lat || !candle.location_anonymized_lng) return;

      // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä
      let found = false;
      for (const [key, cluster] of clusters.entries()) {
        const [lat, lng] = key.split(',').map(Number);
        const distance = Math.sqrt(
          Math.pow(lat - candle.location_anonymized_lat, 2) +
          Math.pow(lng - candle.location_anonymized_lng, 2)
        );

        if (distance < clusterRadius) {
          cluster.push({
            id: candle.id,
            title: candle.title,
            candle_type: candle.candle_type,
            latitude: candle.location_anonymized_lat,
            longitude: candle.location_anonymized_lng,
          });
          found = true;
          break;
        }
      }

      if (!found) {
        const key = `${candle.location_anonymized_lat},${candle.location_anonymized_lng}`;
        clusters.set(key, [
          {
            id: candle.id,
            title: candle.title,
            candle_type: candle.candle_type,
            latitude: candle.location_anonymized_lat,
            longitude: candle.location_anonymized_lng,
          },
        ]);
      }
    });

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –≤ —Ç–æ—á–∫–∏ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
    const result: CandleLocation[] = [];
    clusters.forEach((cluster) => {
      if (cluster.length === 1) {
        result.push(cluster[0]);
      } else {
        // –°—Ä–µ–¥–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Å—É–º–º–∞
        const avgLat =
          cluster.reduce((sum, c) => sum + c.latitude, 0) / cluster.length;
        const avgLng =
          cluster.reduce((sum, c) => sum + c.longitude, 0) / cluster.length;

        result.push({
          id: cluster[0].id,
          title: `${cluster.length} —Å–≤–µ—á–µ–π`,
          candle_type: cluster[0].candle_type,
          latitude: avgLat,
          longitude: avgLng,
          count: cluster.length,
        });
      }
    });

    return result;
  };

  if (loading) {
    return (
      <div
        className="flex items-center justify-center bg-slate-100 rounded-lg"
        style={{ height }}
      >
        <p className="text-slate-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
      </div>
    );
  }

  if (candles.length === 0) {
    return (
      <div
        className="flex items-center justify-center bg-slate-100 rounded-lg"
        style={{ height }}
      >
        <p className="text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤–µ—á–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ</p>
      </div>
    );
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
  const defaultBounds = L.latLngBounds(
    candles.map((c) => [c.latitude, c.longitude])
  );

  return (
    <div className="w-full rounded-lg overflow-hidden border border-slate-200" style={{ height }}>
      <MapContainer
        center={[defaultBounds.getCenter().lat, defaultBounds.getCenter().lng]}
        zoom={2}
        style={{ height: '100%', width: '100%' }}
        scrollWheelZoom={true}
      >
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />

        {candles.map((candle) => (
          <Marker
            key={candle.id}
            position={[candle.latitude, candle.longitude]}
            icon={L.divIcon({
              html: getCandleIcon(candle.candle_type, candle.count),
              className: 'custom-marker',
              iconSize: [30, 30],
            })}
          >
            <Popup>
              <div className="p-2">
                <p className="font-medium">{candle.title}</p>
                {candle.count && (
                  <p className="text-sm text-slate-600">{candle.count} —Å–≤–µ—á–µ–π –∑–¥–µ—Å—å</p>
                )}
              </div>
            </Popup>
          </Marker>
        ))}
      </MapContainer>
    </div>
  );
}

// –ò–∫–æ–Ω–∫–∞ —Å–≤–µ—á–∏ –ø–æ —Ç–∏–ø—É
function getCandleIcon(candleType: string, count?: number): string {
  const emojiMap: Record<string, string> = {
    calm: 'üïäÔ∏è',
    support: 'ü§ù',
    memory: 'üåô',
    gratitude: '‚ú®',
    focus: 'üéØ',
  };

  const emoji = emojiMap[candleType] || 'üïØÔ∏è';

  if (count && count > 1) {
    return `
      <div style="
        background: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        font-size: 16px;
        position: relative;
      ">
        ${emoji}
        <span style="
          position: absolute;
          bottom: -5px;
          right: -5px;
          background: #f59e0b;
          color: white;
          border-radius: 50%;
          width: 18px;
          height: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: bold;
        ">${count}</span>
      </div>
    `;
  }

  return `
    <div style="
      background: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      font-size: 16px;
    ">
      ${emoji}
    </div>
  `;
}
```

### 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–≤–µ—á–∏

```typescript
// components/geographic/LocationDisplay.tsx
'use client';

import Link from 'next/link';
import { LocationData } from '@/lib/geocoding';

interface LocationDisplayProps {
  location: LocationData;
  candleId?: string;
  showLink?: boolean;
}

export function LocationDisplay({
  location,
  candleId,
  showLink = true,
}: LocationDisplayProps) {
  const locationText = [
    location.city,
    location.country,
  ]
    .filter(Boolean)
    .join(', ');

  if (!locationText) return null;

  return (
    <div className="flex items-center gap-2 text-sm text-slate-600">
      <span>üìç</span>
      {showLink && candleId ? (
        <Link
          href={`/locations?country=${location.country}&city=${location.city}`}
          className="hover:text-amber-600 underline"
        >
          {locationText}
        </Link>
      ) : (
        <span>{locationText}</span>
      )}
    </div>
  );
}
```

### 4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ –º–µ—Å—Ç—É

```typescript
// components/geographic/LocationCollection.tsx
'use client';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import Link from 'next/link';

interface LocationCollectionProps {
  country?: string;
  city?: string;
  region?: string;
}

export function LocationCollection({
  country,
  city,
  region,
}: LocationCollectionProps) {
  const [candles, setCandles] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadCandles();
  }, [country, city, region]);

  const loadCandles = async () => {
    try {
      let query = supabase
        .from('candles')
        .select('id, title, message, candle_type, created_at')
        .eq('status', 'active')
        .order('created_at', { ascending: false })
        .limit(50);

      if (country) {
        query = query.eq('location_country', country);
      }
      if (city) {
        query = query.eq('location_city', city);
      }
      if (region) {
        query = query.eq('location_region', region);
      }

      const { data, error } = await query;

      if (error) throw error;
      setCandles(data || []);
    } catch (error) {
      console.error('Error loading location collection:', error);
    } finally {
      setLoading(false);
    }
  };

  const locationName = [city, country].filter(Boolean).join(', ') || region;

  if (loading) {
    return <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>;
  }

  return (
    <div className="space-y-4">
      <div>
        <h2 className="text-2xl font-bold text-slate-900">
          –°–≤–µ—á–∏: {locationName}
        </h2>
        <p className="text-slate-600 mt-1">
          {candles.length} {candles.length === 1 ? '—Å–≤–µ—á–∞' : '—Å–≤–µ—á–µ–π'}
        </p>
      </div>

      {candles.length === 0 ? (
        <p className="text-slate-600">–ü–æ–∫–∞ –Ω–µ—Ç —Å–≤–µ—á–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞</p>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {candles.map((candle) => (
            <Link
              key={candle.id}
              href={`/candle/${candle.id}`}
              className="p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors"
            >
              <h3 className="font-medium text-slate-900">{candle.title}</h3>
              {candle.message && (
                <p className="text-sm text-slate-600 mt-1 line-clamp-2">
                  {candle.message}
                </p>
              )}
            </Link>
          ))}
        </div>
      )}
    </div>
  );
}
```

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install leaflet react-leaflet node-geocoder
npm install --save-dev @types/leaflet
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

1. –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç

1. –°–æ–∑–¥–∞—Ç—å `lib/geocoding.ts` —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞
2. –°–æ–∑–¥–∞—Ç—å API route `app/api/geocode/route.ts`

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

1. –°–æ–∑–¥–∞—Ç—å `components/geographic/LocationSelector.tsx`
2. –°–æ–∑–¥–∞—Ç—å `components/geographic/CandlesMap.tsx`
3. –°–æ–∑–¥–∞—Ç—å `components/geographic/LocationDisplay.tsx`
4. –°–æ–∑–¥–∞—Ç—å `components/geographic/LocationCollection.tsx`

### –®–∞–≥ 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–µ—á–∏

```typescript
// app/[locale]/light/page.tsx
import { LocationSelector } from '@/components/geographic/LocationSelector';

// –í —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–µ—á–∏:
const [location, setLocation] = useState<LocationData | null>(null);

// –í JSX:
<LocationSelector
  onLocationSelect={setLocation}
  required={false}
/>

// –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–≤–µ—á–∏:
const candleData = {
  // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
  location_type: location ? determineLocationType(location) : 'none',
  location_country: location?.country || null,
  location_city: location?.city || null,
  location_region: location?.region || null,
  location_latitude: location?.latitude || null,
  location_longitude: location?.longitude || null,
  location_anonymized_lat: location ? anonymizeCoordinates(location.latitude!, location.longitude!).latitude : null,
  location_anonymized_lng: location ? anonymizeCoordinates(location.latitude!, location.longitude!).longitude : null,
  location_show_on_map: showOnMap,
  location_address: location?.address || null,
};
```

### –®–∞–≥ 6: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã

```typescript
// app/[locale]/locations/page.tsx - –Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
import { CandlesMap } from '@/components/geographic/CandlesMap';

export default function LocationsPage() {
  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-4">–ö–∞—Ä—Ç–∞ —Å–≤–µ—á–µ–π</h1>
      <CandlesMap height="600px" />
    </div>
  );
}
```

### –®–∞–≥ 7: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–≤–µ—á–∏

```typescript
// app/[locale]/candle/[id]/page.tsx
import { LocationDisplay } from '@/components/geographic/LocationDisplay';

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
{candle.location_city && (
  <LocationDisplay
    location={{
      city: candle.location_city,
      country: candle.location_country,
    }}
    candleId={candle.id}
    showLink={true}
  />
)}
```

---

## üîí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. Rate Limiting –¥–ª—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

```typescript
// lib/rateLimiter.ts
const geocodeRequests = new Map<string, number[]>();

export function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const windowMs = 60000; // 1 –º–∏–Ω—É—Ç–∞
  const maxRequests = 10;

  const requests = geocodeRequests.get(ip) || [];
  const recentRequests = requests.filter((time) => now - time < windowMs);

  if (recentRequests.length >= maxRequests) {
    return false;
  }

  recentRequests.push(now);
  geocodeRequests.set(ip, recentRequests);

  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
  setTimeout(() => {
    geocodeRequests.delete(ip);
  }, windowMs * 2);

  return true;
}
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

```typescript
// lib/geocoding.ts
const geocodeCache = new Map<string, GeocodeResult>();

export async function geocodeLocationCached(
  query: string,
  precisionLevel: number = 2
): Promise<GeocodeResult | null> {
  const cacheKey = `${query}:${precisionLevel}`;
  
  if (geocodeCache.has(cacheKey)) {
    return geocodeCache.get(cacheKey)!;
  }

  const result = await geocodeLocation(query, precisionLevel);
  if (result) {
    geocodeCache.set(cacheKey, result);
    // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —á–µ—Ä–µ–∑ —á–∞—Å
    setTimeout(() => geocodeCache.delete(cacheKey), 3600000);
  }

  return result;
}
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∫–∞—Ä—Ç–µ

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
// –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤–µ—á–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º (lazy loading)
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é –º–∞—Ä–∫–µ—Ä–æ–≤ (leaflet.markercluster)
```

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```typescript
// lib/validation.ts
export function validateLocation(location: LocationData): boolean {
  if (!location.latitude || !location.longitude) return false;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
  if (location.latitude < -90 || location.latitude > 90) return false;
  if (location.longitude < -180 || location.longitude > 180) return false;
  
  return true;
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç—ã –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

```typescript
// __tests__/geocoding.test.ts
import { geocodeLocation } from '@/lib/geocoding';

describe('Geocoding', () => {
  it('should geocode Moscow correctly', async () => {
    const result = await geocodeLocation('Moscow, Russia');
    expect(result?.location.city).toBe('Moscow');
    expect(result?.location.country).toBe('Russia');
    expect(result?.location.latitude).toBeDefined();
  });

  it('should anonymize coordinates', () => {
    // –¢–µ—Å—Ç—ã –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏
  });
});
```

### 2. –¢–µ—Å—Ç—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```typescript
// __tests__/LocationSelector.test.tsx
import { render, screen } from '@testing-library/react';
import { LocationSelector } from '@/components/geographic/LocationSelector';

describe('LocationSelector', () => {
  it('renders search input', () => {
    render(<LocationSelector onLocationSelect={() => {}} />);
    expect(screen.getByPlaceholderText(/–≥–æ—Ä–æ–¥/i)).toBeInTheDocument();
  });
});
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:
- ‚úÖ –í—Ä–µ–º—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ < 2 —Å–µ–∫—É–Ω–¥
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã < 3 —Å–µ–∫—É–Ω–¥
- ‚úÖ FPS –Ω–∞ –∫–∞—Ä—Ç–µ > 30
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:
- ‚úÖ Adoption rate > 15% (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤–ª—è—é—Ç –º–µ—Å—Ç–∞)
- ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–∑—ã–≤—ã –æ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ engagement –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ä—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–π –ø–æ –º–µ—Å—Ç–∞–º

---

## üöÄ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (1-2 –Ω–µ–¥–µ–ª–∏)
1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
2. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ API
3. –í—ã–±–æ—Ä –º–µ—Å—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–≤–µ—á–∏
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

### –§–∞–∑–∞ 2: –ö–∞—Ä—Ç–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (1 –Ω–µ–¥–µ–ª—è)
1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Leaflet
2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã
3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–µ—á–µ–π
4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–∞—Ä—Ç–æ–π

### –§–∞–∑–∞ 3: –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (1 –Ω–µ–¥–µ–ª—è)
1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π
2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π
3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—Ç–∞–º
4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –§–∞–∑–∞ 4: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ (3-5 –¥–Ω–µ–π)
1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
4. –£–ª—É—á—à–µ–Ω–∏—è UX

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
