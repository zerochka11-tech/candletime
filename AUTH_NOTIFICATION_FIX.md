# Исправление багов с уведомлениями и миганием экрана

## Проблемы

### 1. Сообщение "Вы вошли в аккаунт" при перезагрузке страницы
**Проблема**: При перезагрузке любой страницы появлялось уведомление "Вы вошли в аккаунт", хотя пользователь уже был авторизован.

**Причина**: Подписка на `onAuthStateChange` в `SiteHeader.tsx` срабатывала при событии `SIGNED_IN`, которое может происходить не только при реальном входе, но и при восстановлении сессии при перезагрузке страницы.

### 2. Мигание экрана логина на `/admin/articles`
**Проблема**: При перезагрузке страницы `/admin/articles` сначала появлялось сообщение "Вы вошли в аккаунт", затем экран логина, и только потом отрисовывался контент.

**Причина**: 
- `AdminGuard` возвращал `null` во время проверки доступа, что вызывало мигание
- Проверка доступа происходила асинхронно, и до её завершения показывался пустой экран
- Если проверка занимала время, происходил редирект на логин, который затем сразу редиректил обратно

## Решения

### 1. Исправление в `components/SiteHeader.tsx`

Добавлен флаг `initialLoadComplete`, который отслеживает завершение начальной загрузки пользователя. Уведомления показываются только после завершения начальной загрузки, что предотвращает показ "Вы вошли в аккаунт" при перезагрузке страницы.

**Изменения**:
```typescript
let initialLoadComplete = false;

const loadUser = async () => {
  // ... загрузка пользователя ...
  finally {
    setLoading(false);
    initialLoadComplete = true; // Помечаем, что начальная загрузка завершена
  }
};

supabase.auth.onAuthStateChange(async (event, session) => {
  // Игнорируем события, которые происходят до завершения начальной загрузки
  if (!initialLoadComplete) {
    return;
  }
  
  // Показываем уведомление только при реальном входе/выходе
  if (event === 'SIGNED_IN') {
    // ...
  }
});
```

### 2. Исправление в `app/admin/components/AdminGuard.tsx`

Вместо возврата `null` во время проверки доступа теперь показывается индикатор загрузки. Это предотвращает мигание экрана логина при перезагрузке страницы.

**Изменения**:
```typescript
// Пока проверяем - показываем минимальный loading state вместо null
if (isChecking || (!isAuthorized && !shouldRedirect)) {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <div className="text-center">
        <div className="mx-auto h-8 w-8 animate-spin rounded-full border-4 border-slate-200 border-t-slate-900 dark:border-slate-700 dark:border-t-slate-100"></div>
        <p className="mt-4 text-sm text-slate-600 dark:text-slate-400">Проверка доступа...</p>
      </div>
    </div>
  );
}
```

Также добавлена задержка перед редиректом, чтобы избежать мигания:
```typescript
setTimeout(() => {
  router.replace(`/auth/login?redirect=${encodeURIComponent(redirectPath)}`);
}, 100);
```

## Результат

✅ Уведомление "Вы вошли в аккаунт" больше не появляется при перезагрузке страницы  
✅ На странице `/admin/articles` нет мигания экрана логина при перезагрузке  
✅ Пользователь видит плавный переход с индикатором загрузки вместо пустого экрана  
✅ Улучшен пользовательский опыт при работе с админ-панелью

## Файлы изменены

- `components/SiteHeader.tsx` - исправлена логика показа уведомлений
- `app/admin/components/AdminGuard.tsx` - добавлен loading state вместо null

## Дата исправления

2025-01-10

